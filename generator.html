<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>HARDBEAT FACTORY - CONVERTER V19.2</title>
    <style>
        :root { --bg: #0d0d0d; --panel: #1a1a1a; --cyan: #00f3ff; --purple: #a855f7; --yellow: #ffcc00; --text: #ccc; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', monospace; padding: 20px; display: flex; justify-content: center; }
        .container { width: 900px; background: var(--panel); padding: 30px; border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        h1 { color: var(--cyan); text-align: center; border-bottom: 1px solid #333; padding-bottom: 20px; margin-top: 0; }
        .subtitle { text-align: center; color: #666; font-size: 12px; margin-bottom: 30px; }

        /* DROP ZONE */
        .drop-zone {
            border: 2px dashed #444;
            border-radius: 10px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            transition: 0.3s;
            background: #111;
            color: #666;
            margin-bottom: 20px;
        }
        .drop-zone:hover { border-color: var(--cyan); color: var(--cyan); background: #151515; }
        .drop-zone.active { border-color: var(--yellow); color: var(--yellow); background: #222; }
        
        /* INPUTS */
        .meta-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .col { flex: 1; }
        label { display: block; font-size: 10px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        input[type="text"] { width: 100%; background: #050505; border: 1px solid #444; color: #fff; padding: 10px; font-family: monospace; font-size: 14px; box-sizing: border-box; }
        input:focus { border-color: var(--cyan); outline: none; }

        /* OUTPUT */
        textarea { 
            width: 100%; height: 400px; 
            background: #080808; color: #0f0; 
            border: 1px solid #333; padding: 15px; 
            font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.4;
            box-sizing: border-box; resize: vertical;
        }

        button { width: 100%; padding: 15px; background: var(--cyan); border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; text-transform: uppercase; }
        button:hover { background: #fff; }

        .status { text-align: center; margin-top: 10px; font-size: 12px; height: 15px; color: var(--yellow); }
    </style>
</head>
<body>

<div class="container">
    <h1>üè≠ FACTORY PRESET CONVERTER V19.2</h1>
    <p class="subtitle">Transforme un fichier JSON (Export User) en code JS (Factory Preset)</p>

    <div class="drop-zone" id="drop-zone">
        <span style="font-size: 24px;">üìÇ</span>
        <span>GLISSE TON FICHIER .JSON ICI</span>
        <span style="font-size: 10px; margin-top:5px;">(ou clique pour parcourir)</span>
        <input type="file" id="file-input" accept=".json" style="display:none">
    </div>

    <div class="meta-row">
        <div class="col">
            <label>ID DU PRESET (ex: my_techno_1)</label>
            <input type="text" id="p-id" placeholder="my_preset_id" oninput="renderCodeFromCache()">
        </div>
        <div class="col">
            <label>NOM AFFICHE (ex: BERLIN RUMBLE)</label>
            <input type="text" id="p-name" placeholder="MY COOL PRESET" oninput="renderCodeFromCache()">
        </div>
    </div>

    <div class="status" id="status-msg"></div>

    <textarea id="output" readonly placeholder="Le code magique appara√Ætra ici..."></textarea>
    <button onclick="copyToClipboard()">COPIER LE CODE</button>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const output = document.getElementById('output');
    const statusMsg = document.getElementById('status-msg');
    
    // VARIABLE GLOBALE POUR STOCKER LE JSON CHARG√â
    let loadedData = null;

    // --- GESTION DRAG & DROP ---
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault(); dropZone.classList.add('active');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); dropZone.classList.remove('active');
        const file = e.dataTransfer.files[0];
        if(file) processFile(file);
    });

    fileInput.addEventListener('change', (e) => {
        if(e.target.files[0]) processFile(e.target.files[0]);
    });

    // --- HELPER ---
    function boolsToIndices(arr) {
        if(!Array.isArray(arr)) return [];
        return arr.map((val, i) => val ? i : -1).filter(i => i !== -1);
    }

    // --- LECTURE DU FICHIER ---
    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                loadedData = JSON.parse(e.target.result);
                
                // Pr√©-remplissage
                const defaultName = loadedData.name ? loadedData.name.toUpperCase() : "UNTITLED";
                const defaultID = defaultName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

                document.getElementById('p-name').value = defaultName;
                if(!document.getElementById('p-id').value) {
                    document.getElementById('p-id').value = defaultID;
                }

                // G√©n√©ration
                renderCodeFromCache();
                statusMsg.innerText = "‚úÖ FICHIER ANALYS√â AVEC SUCC√àS !";
            } catch(err) {
                alert("Erreur JSON: " + err.message);
            }
        };
        reader.readAsText(file);
    }

    // --- GENERATION DU CODE ---
    function renderCodeFromCache() {
        if (!loadedData) return;

        const data = loadedData;
        const id = document.getElementById('p-id').value || "new_preset";
        const name = document.getElementById('p-name').value || "USER PRESET";

        // 1. DATA GLOBALE
        const bpm = data.global ? data.global.bpm : data.bpm;
        const swing = (data.global && data.global.swing) ? data.global.swing : 0;
        const len = data.global ? data.global.len : 64;
        
        // üö® CORRECTIF ICI : Support de 'trackLens' (nom utilis√© par IO.js) ET 'trackLengths'
        let trackLengths = [16,16,16,16,16];
        if(data.global) {
            if(data.global.trackLengths) trackLengths = data.global.trackLengths;
            else if(data.global.trackLens) trackLengths = data.global.trackLens;
        } else if (data.trackLengths) {
            trackLengths = data.trackLengths;
        }

        // 2. CONTROLS
        let controls = {};
        if(data.controls) {
            controls = JSON.parse(JSON.stringify(data.controls)); 
        }

        // 3. DRUMS
        const drumSeqsIndices = data.drums.seq.map(seq => boolsToIndices(seq));
        const drumAccsIndices = data.drums.acc.map(seq => boolsToIndices(seq));

        // 4. SYNTHS
        const s2Seq = boolsToIndices(data.synths.seq2);
        const s3Seq = boolsToIndices(data.synths.seq3);
        const s2Acc = boolsToIndices(data.synths.acc2 || []);
        const s3Acc = boolsToIndices(data.synths.acc3 || []);

        // 5. FREQS
        const roundArr = (arr) => arr.map(x => Math.round(x * 10) / 10);
        const f2 = roundArr(data.freqs.seq2);
        const f3 = roundArr(data.freqs.seq3);
        const fmFreqs = data.freqs.fm ? roundArr(data.freqs.fm) : [];

        // 6. CHORDS
        const chords = data.chords ? data.chords.qual : [];

        // --- CONSTRUCTION DU STRING JS ---
        const jsCode = `
    "${id}": {
        name: "${name}",
        masterLength: ${len},
        bpm: ${bpm},
        swing: ${swing},
        trackLengths: [${trackLengths.join(', ')}],
        
        // --- V19 CONTROLS ---
        controls: ${JSON.stringify(controls, null, 8).replace(/\n\s{8}/g, '\n            ').replace('}', '        }')},

        drums: {
            seq: [
                makeSeq([${drumSeqsIndices[0].join(', ')}]), // KICK
                makeSeq([${drumSeqsIndices[1].join(', ')}]), // SNARE
                makeSeq([${drumSeqsIndices[2].join(', ')}]), // HHC
                makeSeq([${drumSeqsIndices[3].join(', ')}]), // HHO
                makeSeq([${drumSeqsIndices[4].join(', ')}])  // FM
            ],
            accents: [
                makeSeq([${drumAccsIndices[0].join(', ')}]),
                makeSeq([${drumAccsIndices[1].join(', ')}]),
                makeSeq([${drumAccsIndices[2].join(', ')}]),
                makeSeq([${drumAccsIndices[3].join(', ')}]),
                makeSeq([${drumAccsIndices[4].join(', ')}])
            ],
            fmFreqs: [${fmFreqs.join(', ')}]
        },

        synths: {
            seq2: makeSeq([${s2Seq.join(', ')}]),
            seq3: makeSeq([${s3Seq.join(', ')}]),
            acc2: makeSeq([${s2Acc.join(', ')}]),
            acc3: makeSeq([${s3Acc.join(', ')}])
        },

        freqs2: [${f2.join(', ')}],
        freqs3: [${f3.join(', ')}],
        
        chords: {
            qual: [${chords.join(', ')}]
        }
    },`;

        output.value = jsCode;
    }

    function copyToClipboard() {
        output.select();
        document.execCommand('copy');
        statusMsg.innerText = "COPI√â DANS LE PRESSE-PAPIER !";
        setTimeout(() => statusMsg.innerText = "", 3000);
    }
</script>

</body>
</html>
