<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>HARDBEAT FACTORY - CONVERTER V21 (SECURE)</title>
    <style>
        :root { --bg: #0d0d0d; --panel: #1a1a1a; --cyan: #00f3ff; --purple: #a855f7; --yellow: #ffcc00; --text: #ccc; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', monospace; padding: 20px; display: flex; justify-content: center; }
        .container { width: 900px; background: var(--panel); padding: 30px; border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        h1 { color: var(--purple); text-align: center; border-bottom: 1px solid #333; padding-bottom: 20px; margin-top: 0; }
        .subtitle { text-align: center; color: #666; font-size: 12px; margin-bottom: 30px; }

        /* DROP ZONE */
        .drop-zone {
            border: 2px dashed #444;
            border-radius: 10px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer; /* Indique que c'est cliquable */
            transition: 0.3s;
            background: #111;
            color: #666;
            margin-bottom: 20px;
            position: relative;
        }
        .drop-zone:hover { border-color: var(--cyan); color: var(--cyan); background: #151515; }
        .drop-zone.active { border-color: var(--yellow); color: var(--yellow); background: #222; }
        
        /* INPUTS */
        .meta-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .col { flex: 1; }
        label { display: block; font-size: 10px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        input[type="text"] { width: 100%; background: #050505; border: 1px solid #444; color: #fff; padding: 10px; font-family: monospace; font-size: 14px; box-sizing: border-box; }
        input:focus { border-color: var(--cyan); outline: none; }

        /* OUTPUT */
        textarea { 
            width: 100%; height: 400px; 
            background: #080808; color: #0f0; 
            border: 1px solid #333; padding: 15px; 
            font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.4;
            box-sizing: border-box; resize: vertical;
        }

        button { width: 100%; padding: 15px; background: var(--purple); color: #fff; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; text-transform: uppercase; }
        button:hover { background: #fff; color: #000; }

        .status { text-align: center; margin-top: 10px; font-size: 12px; height: 15px; color: var(--yellow); }
        .security-badge { text-align:center; font-size:10px; color:#444; margin-top:5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üè≠ FACTORY GENERATOR V21</h1>
    <p class="subtitle">Convertisseur JSON vers JS (S√©curis√© & Compatible Rumble/Solos)</p>

    <div class="drop-zone" id="drop-zone">
        <span style="font-size: 24px;">üõ°Ô∏è</span>
        <span>GLISSE TON FICHIER .JSON ICI</span>
        <span style="font-size: 10px; margin-top:5px;">(Ou clique pour parcourir)</span>
    </div>
    
    <input type="file" id="file-input" accept=".json" style="display:none">

    <div class="meta-row">
        <div class="col">
            <label>ID DU PRESET (Sans espaces, s√©curis√©)</label>
            <input type="text" id="p-id" placeholder="my_techno_1" oninput="renderCodeFromCache()">
        </div>
        <div class="col">
            <label>NOM AFFICHE (Nettoy√© automatiquement)</label>
            <input type="text" id="p-name" placeholder="MY PRESET" oninput="renderCodeFromCache()">
        </div>
    </div>

    <div class="status" id="status-msg"></div>

    <textarea id="output" readonly placeholder="En attente de fichier..."></textarea>
    <button onclick="copyToClipboard()">COPIER LE CODE S√âCURIS√â</button>
    <div class="security-badge">üîí Input Sanitization Active</div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const output = document.getElementById('output');
    const statusMsg = document.getElementById('status-msg');
    
    let loadedData = null;

    // --- SECURITY SANITIZER ---
    function sanitizeInput(str, isId = false) {
        if (!str) return "";
        if (isId) return str.replace(/[^a-zA-Z0-9_]/g, "").toLowerCase();
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "").replace(/'/g, "").replace(/`/g, "").replace(/\\/g, "");
    }

    // --- CLICK & DRAG HANDLING ---
    // 1. Clic sur la zone d√©clenche l'input cach√©
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });

    // 2. Gestion du Drag & Drop
    dropZone.addEventListener('dragover', (e) => { 
        e.preventDefault(); 
        dropZone.classList.add('active'); 
    });
    
    dropZone.addEventListener('dragleave', () => { 
        dropZone.classList.remove('active'); 
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); 
        dropZone.classList.remove('active');
        if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
    });

    // 3. Gestion du fichier s√©lectionn√© via le clic
    fileInput.addEventListener('change', (e) => { 
        if(e.target.files[0]) processFile(e.target.files[0]); 
    });

    // --- HELPER ---
    function boolsToIndices(arr) {
        if(!Array.isArray(arr)) return [];
        return arr.map((val, i) => val ? i : -1).filter(i => i !== -1);
    }

    // --- LECTURE ---
    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                loadedData = JSON.parse(e.target.result);
                
                // Pr√©-remplissage
                const rawName = loadedData.name || "UNTITLED";
                const cleanName = sanitizeInput(rawName);
                const cleanID = cleanName.toLowerCase().replace(/\s+/g, '_');

                document.getElementById('p-name').value = cleanName;
                if(!document.getElementById('p-id').value) {
                    document.getElementById('p-id').value = cleanID;
                }

                renderCodeFromCache();
                statusMsg.innerText = "‚úÖ JSON VALIDE & S√âCURIS√â";
                statusMsg.style.color = "#0f0";
            } catch(err) {
                alert("Fichier corrompu : " + err.message);
            }
        };
        reader.readAsText(file);
    }

    // --- GENERATION (ENGINE V21) ---
    function renderCodeFromCache() {
        if (!loadedData) return;
        const data = loadedData;
        
        const rawId = document.getElementById('p-id').value || "new_preset";
        const id = sanitizeInput(rawId, true);
        const rawName = document.getElementById('p-name').value || "USER PRESET";
        const name = sanitizeInput(rawName, false);

        const bpm = data.global ? data.global.bpm : (data.bpm || 120);
        const swing = (data.global && data.global.swing !== undefined) ? data.global.swing : 0;
        const len = data.global ? data.global.len : 16;
        
        let trackLengths = [16,16,16,16,16];
        if(data.global) {
            if(data.global.trackLengths) trackLengths = data.global.trackLengths;
            else if(data.global.trackLens) trackLengths = data.global.trackLens;
        } else if (data.trackLengths) {
            trackLengths = data.trackLengths;
        }

        let controls = {};
        if(data.controls) controls = JSON.parse(JSON.stringify(data.controls)); 

        const mutes = data.mutes || [false, false, false, false, false];
        const solos = data.solos || [false, false, false, false, false];

        const dSeq = data.drums && data.drums.seq ? data.drums.seq : [[],[],[],[],[]];
        const dAcc = data.drums && (data.drums.acc || data.drums.accents) ? (data.drums.acc || data.drums.accents) : [[],[],[],[],[]];
        
        const drumSeqsIndices = dSeq.map(seq => boolsToIndices(seq));
        const drumAccsIndices = dAcc.map(seq => boolsToIndices(seq));

        const synths = data.synths || {};
        const s2Seq = boolsToIndices(synths.seq2 || []);
        const s3Seq = boolsToIndices(synths.seq3 || []);
        const s2Acc = boolsToIndices(synths.acc2 || []);
        const s3Acc = boolsToIndices(synths.acc3 || []);

        const roundArr = (arr) => arr ? arr.map(x => Math.round(x * 10) / 10) : [];
        const freqs = data.freqs || {};
        const f2 = roundArr(freqs.seq2 || data.freqs2);
        const f3 = roundArr(freqs.seq3 || data.freqs3);
        const fmFreqs = freqs.fm ? roundArr(freqs.fm) : [];

        const chords = (data.chords && data.chords.qual) ? data.chords.qual : [];

        const jsCode = `
    "${id}": {
        name: "${name}",
        masterLength: ${len},
        bpm: ${bpm},
        swing: ${swing},
        trackLengths: [${trackLengths.join(', ')}],
        
        // --- V21 CONTROLS (Knobs + Rumble) ---
        controls: ${JSON.stringify(controls, null, 8).replace(/\n\s{8}/g, '\n            ').replace('}', '        }')},

        // --- V21 MIXER STATE ---
        mutes: [${mutes.join(', ')}],
        solos: [${solos.join(', ')}],

        drums: {
            seq: [
                makeSeq([${drumSeqsIndices[0].join(', ')}]), // KICK
                makeSeq([${drumSeqsIndices[1].join(', ')}]), // SNARE
                makeSeq([${drumSeqsIndices[2].join(', ')}]), // HHC
                makeSeq([${drumSeqsIndices[3].join(', ')}]), // HHO
                makeSeq([${drumSeqsIndices[4].join(', ')}])  // FM
            ],
            accents: [
                makeSeq([${drumAccsIndices[0].join(', ')}]),
                makeSeq([${drumAccsIndices[1].join(', ')}]),
                makeSeq([${drumAccsIndices[2].join(', ')}]),
                makeSeq([${drumAccsIndices[3].join(', ')}]),
                makeSeq([${drumAccsIndices[4].join(', ')}])
            ],
            fmFreqs: [${fmFreqs.join(', ')}]
        },

        synths: {
            seq2: makeSeq([${s2Seq.join(', ')}]),
            seq3: makeSeq([${s3Seq.join(', ')}]),
            acc2: makeSeq([${s2Acc.join(', ')}]),
            acc3: makeSeq([${s3Acc.join(', ')}])
        },

        freqs2: [${f2.join(', ')}],
        freqs3: [${f3.join(', ')}],
        
        chords: {
            qual: [${chords.join(', ')}]
        }
    },`;

        output.value = jsCode;
    }

    function copyToClipboard() {
        if(!output.value) return;
        output.select();
        document.execCommand('copy');
        statusMsg.innerText = "COPI√â DANS LE PRESSE-PAPIER !";
        setTimeout(() => statusMsg.innerText = "", 3000);
    }
</script>

</body>
</html>
